#!/bin/bash
# surrogate
# loren carvalho, 2012
set -u

which innobackupex 2> /dev/null
if [ $? -gt 0 ]; then
  echo "Can not find innobackupex!"
  echo "Please install Percona XtraBackup and try again"
  exit 1
fi

if [ "$(whoami)" != "root" ]; then
  if [ -f `which sudo` ]; then
    sudo $0 "$@"
    exit $?
  else
    usage
  fi
fi

# configs
source /etc/surrogate/surrogate.conf
source /etc/surrogate/xtrabackup.conf
source /usr/local/lib/surrogate/lib/surrogate

# explain the usage
function usage() { 
cat <<-EOF
	usage: $0 options

	This script must be run with sudo or as root, 
  it also expects some arguments, please oblige!

	OPTIONS:

	-h	Shows this message
	-b	Backup, either incremental or full, 
      "surrogate -b full" or "surrogate -b inc"
	-r 	Restore, accepts the full path of a restorable directory
	
EOF
exit 1
}

# empty vars on initial call, can reuse init() if needed
function init() {
  type=""
  restore=""
  promote=""
}

init

# quietly run the rotation function
rotate_backups

# if there is no input, barf
[[ ! $1 ]] && { usage; }

# get input
while getopts "hb:r:" option 
do
  case $option in
  h)
    usage
  ;;
  b)
    type=$OPTARG
    if [[ "$type" == "full" ]]; then
      source $my_root/lib/actions/full
    elif [[ "$type" == "inc" ]]; then
      source $my_root/lib/actions/inc
    else	
      echo "Please specify full or incremental"
      usage
    fi
  ;;
  r)
    restore=$OPTARG
    source $my_root/lib/actions/restore
  ;;
  esac
done

# Perform the loaded action
perform_action

# fin
